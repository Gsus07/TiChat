---
import { getGameWithTheme, getServerBySlugWithTheme } from '../../utils/games';
import ServerTemplate from '../../components/ServerTemplate.astro';

export const prerender = true;

export async function getStaticPaths() {
  // En desarrollo, retornamos un array vacío para permitir generación bajo demanda
  // En producción, aquí generaríamos todas las rutas estáticas
  return [];
}

const { game: gameName, server: serverName } = Astro.params;

if (!gameName || !serverName) {
  return Astro.redirect('/404');
}

// Asegurar que son strings después de la validación
const gameNameString = gameName as string;
const serverNameString = serverName as string;

// Convertir el slug de la URL al nombre del juego
const gameNameFormatted = gameNameString
  .split('-')
  .map((word: string) => word.charAt(0).toUpperCase() + word.slice(1))
  .join(' ');

// Usar el slug del servidor directamente
const serverSlug = serverNameString;

// Obtener datos del juego
const { data: game, error: gameError } = await getGameWithTheme(gameNameFormatted);

if (gameError || !game) {
  return Astro.redirect('/404');
}

// Obtener datos del servidor combinando tema con slug
const { data: server, error: serverError } = await getServerBySlugWithTheme(serverSlug, game.id);

if (serverError || !server) {
  return Astro.redirect(`/${gameName}`);
}

// El servidor ya trae la combinación default -> juego -> servidor
const combinedThemeConfig = server.theme_config;
---

<ServerTemplate 
  server={server}
  game={game}
  themeConfig={combinedThemeConfig || {}}
/>