---
import { getGameByName, getServersByGameId, getGameWithTheme } from '../utils/games';
import { getPostsByGameId } from '../utils/posts';
import GameTemplate from '../components/GameTemplate.astro';
import GameWithServersTemplate from '../components/GameWithServersTemplate.astro';

export async function getStaticPaths() {
  // En desarrollo, retornamos un array vacío para permitir generación bajo demanda
  // En producción, aquí generaríamos todas las rutas estáticas
  return [];
}

const { game: gameName } = Astro.params;

if (!gameName || typeof gameName !== 'string') {
  return Astro.redirect('/404');
}

// Convertir el slug de la URL al nombre del juego
let gameNameFormatted = (gameName as string)
  .split('-')
  .map((word: string) => word.charAt(0).toUpperCase() + word.slice(1))
  .join(' ');

// Manejar casos especiales de nombres de juegos
if (gameNameFormatted === 'Call Of Duty') {
  gameNameFormatted = 'Call of Duty';
} else if (gameNameFormatted === 'Uno') {
  gameNameFormatted = 'UNO';
}

// Obtener datos del juego con tema
const { data: game, error: gameError } = await getGameWithTheme(gameNameFormatted);

if (gameError || !game) {
  console.error('Error fetching game:', gameError);
  return Astro.redirect('/404');
}

// Obtener servidores del juego
const { data: servers, error: serversError } = await getServersByGameId(game.id);

if (serversError) {
  console.error('Error fetching servers:', serversError);
}

const gameServers = servers || [];

// Determinar qué plantilla usar basado en si el juego tiene servidores
const hasServers = gameServers.length > 0;

// Si el juego no tiene servidores, obtener posts del juego
let gamePosts: any[] = [];
if (!hasServers) {
  const { data: posts, error: postsError } = await getPostsByGameId(game.id);
  
  if (postsError) {
    console.error('Error fetching posts:', postsError);
  }
  
  gamePosts = posts || [];
}
---

{!hasServers ? (
  <GameTemplate 
    game={game} 
    themeConfig={game.theme_config || {}}
  />
) : (
  <GameWithServersTemplate 
    game={game}
    themeConfig={game.theme_config || {}}
  />
)}