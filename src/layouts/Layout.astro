---
// src/layouts/Layout.astro
import { ClientRouter } from "astro:transitions";
import '../styles/global.css';
import Navigation from '../components/Navigation.astro';
import NotificationProvider from '../components/react/NotificationProvider.tsx';
import SessionManager from '../components/react/SessionManager.tsx';
import DynamicBackground from '../components/react/DynamicBackground.tsx';
import { ThemeProvider } from '../components/react/ThemeProvider';
import { getInitialTheme } from '../utils/themeManager';
import SimpleThemeToggle from '../components/react/SimpleThemeToggle';

const { title } = Astro.props;
---
<!doctype html>
<html lang="es">
	<head>
		<meta charset="UTF-8" />
		<meta name="viewport" content="width=device-width" />
		<link rel="icon" type="image/png" href="/favicon.png" />
		<meta name="generator" content={Astro.generator} />
		<meta name="theme-color" content="#ffffff" />
		<title>{title}</title>
		<ClientRouter />
		
		<!-- Script para inicializar tema antes del render -->
		<script is:inline set:html={getInitialTheme()}></script>
		
		<!-- Preload critical resources -->
		<!-- SVG preloads removed - images now loaded from database -->
		<!-- Preload fonts and critical CSS -->
		<link rel="preconnect" href="https://fonts.googleapis.com">
		<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
		<!-- DNS prefetch for better performance -->
		<link rel="dns-prefetch" href="//fonts.googleapis.com">
		<link rel="dns-prefetch" href="//fonts.gstatic.com">
	</head>
	<body class="font-sans min-h-screen overflow-x-hidden bg-primary text-primary">
		<!-- Fondo dinámico estático -->
		<div class="fixed inset-0 z-0">
			<!-- Luz central pulsante -->
			<div class="central-light"></div>
			
			<!-- Patrón geométrico sutil -->
			<div class="geometric-pattern"></div>
		</div>

		<!-- Efectos dinámicos interactivos -->
		<DynamicBackground client:load />

		<!-- Contenido principal -->
		<div class="relative z-10">
			<ThemeProvider client:load>
				<NotificationProvider client:load>
					<SessionManager client:load />
					<Navigation />

					<!-- Main content - pages control their own top spacing -->
					<slot />
				</NotificationProvider>
			</ThemeProvider>
			
			<!-- Theme Toggle - Outside of React context to avoid issues -->
			<SimpleThemeToggle client:load />
		</div>
	</body>
</html>

<style>
	/* Estilos base */
	html, body {
		margin: 0;
		width: 100%;
		height: 100%;
	}

	/* Fondo base con soporte para temas */
	body {
		background: linear-gradient(135deg, 
			var(--bg-primary) 0%,
			var(--bg-secondary) 25%,
			var(--bg-tertiary) 50%,
			var(--bg-accent) 75%,
			var(--bg-secondary) 100%
		);
		background-attachment: fixed;
		min-height: 100vh;
		position: relative;
		overflow-x: hidden;
		transition: background var(--theme-transition);
	}

	/* Capa de efectos de luz adaptable al tema */
	body::before {
		content: '';
		position: fixed;
		top: 0;
		left: 0;
		right: 0;
		bottom: 0;
		background: 
			radial-gradient(circle at 20% 80%, var(--color-primary) 0%, transparent 50%),
			radial-gradient(circle at 80% 20%, var(--color-secondary) 0%, transparent 50%),
			radial-gradient(circle at 40% 40%, var(--calico-orange) 0%, transparent 50%);
		opacity: 0.1;
		pointer-events: none;
		z-index: 1;
		transition: background var(--theme-transition), opacity var(--theme-transition);
	}

	/* Efectos de brillo en esquinas - estáticos */
	body::after {
		content: '';
		position: fixed;
		top: 0;
		left: 0;
		right: 0;
		bottom: 0;
		background: 
			radial-gradient(ellipse at top left, rgba(59, 130, 246, 0.15) 0%, transparent 50%),
			radial-gradient(ellipse at top right, rgba(147, 51, 234, 0.15) 0%, transparent 50%),
			radial-gradient(ellipse at bottom left, rgba(236, 72, 153, 0.15) 0%, transparent 50%),
			radial-gradient(ellipse at bottom right, rgba(34, 197, 94, 0.15) 0%, transparent 50%);
		pointer-events: none;
		z-index: 2;
	}

	/* Luz central pulsante - mantener animación sutil */
	.central-light {
		position: fixed;
		top: 50%;
		left: 50%;
		transform: translate(-50%, -50%);
		width: 300px;
		height: 300px;
		background: radial-gradient(circle, rgba(255, 255, 255, 0.1) 0%, transparent 70%);
		border-radius: 50%;
		animation: pulse-slow 4s ease-in-out infinite;
		pointer-events: none;
		z-index: 3;
	}

	/* Patrón geométrico sutil */
	.geometric-pattern {
		position: fixed;
		top: 0;
		left: 0;
		right: 0;
		bottom: 0;
		background-image: 
			linear-gradient(45deg, rgba(255, 255, 255, 0.02) 25%, transparent 25%),
			linear-gradient(-45deg, rgba(255, 255, 255, 0.02) 25%, transparent 25%),
			linear-gradient(45deg, transparent 75%, rgba(255, 255, 255, 0.02) 75%),
			linear-gradient(-45deg, transparent 75%, rgba(255, 255, 255, 0.02) 75%);
		background-size: 60px 60px;
		background-position: 0 0, 0 30px, 30px -30px, -30px 0px;
		pointer-events: none;
		z-index: 1;
	}

	/* Animaciones - solo mantener las necesarias */
	@keyframes pulse-slow {
		0%, 100% { opacity: 0.3; transform: translate(-50%, -50%) scale(1); }
		50% { opacity: 0.6; transform: translate(-50%, -50%) scale(1.1); }
	}

	@keyframes shimmer {
		0% { background-position: -200% 0; }
		100% { background-position: 200% 0; }
	}

	/* Optimizaciones de rendimiento */
	* {
		will-change: auto;
		backface-visibility: hidden;
	}

	html {
		scroll-behavior: smooth;
	}

	/* Ajustes para dispositivos táctiles */
	@media (hover: none) and (pointer: coarse) {
		.central-light {
			animation-duration: 6s;
		}
	}

	/* Reducir efectos en móviles para mejor rendimiento */
	@media (max-width: 768px) {
		body::before,
		body::after {
			opacity: 0.5;
		}
		
		.geometric-pattern {
			background-size: 40px 40px;
		}
	}

	/* Modo de alto contraste */
	@media (prefers-contrast: high) {
		body::before,
		body::after,
		.central-light {
			display: none;
		}
	}

	/* Respetar preferencias de movimiento reducido */
	@media (prefers-reduced-motion: reduce) {
		.central-light {
			animation: none;
		}
	}
</style>
